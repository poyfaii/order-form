<!DOCTYPE html>
<html lang="th">
<head>
  <meta charset="UTF-8" />
  <title>ร้านแม่ดอน - Admin</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <script src="https://cdn.tailwindcss.com"></script>
</head>
<body class="bg-gray-50 min-h-screen text-gray-800">

  <!-- Login Section -->
  <div id="login-section" class="flex flex-col items-center justify-center min-h-screen">
    <h2 class="text-2xl font-bold mb-4">เข้าสู่ระบบร้านค้า</h2>
    <input id="email" type="email" placeholder="Email" class="border px-3 py-2 mb-2 w-64 rounded" />
    <input id="password" type="password" placeholder="Password" class="border px-3 py-2 mb-2 w-64 rounded" />
    <button onclick="login()" class="bg-green-600 text-white px-4 py-2 rounded">เข้าสู่ระบบ</button>
    <p id="login-error" class="text-red-500 mt-2 hidden">เข้าสู่ระบบไม่สำเร็จ</p>
  </div>

  <!-- Admin Panel -->
  <div id="admin-panel" class="hidden p-6 max-w-2xl mx-auto">
    <h1 class="text-2xl font-bold mb-4">เพิ่ม / แก้ไขสินค้า</h1>
    
    <input id="product-name" type="text" placeholder="ชื่อสินค้า" class="w-full mb-2 p-2 border rounded" />
    
    <input id="product-category" type="text" placeholder="หมวดหมู่ (เช่น กล้วย)" class="w-full mb-2 p-2 border rounded" />
    
    <textarea id="product-price" placeholder="ราคาหลายขนาด เช่น 500g=80,1kg=150,ลัง=400" class="w-full mb-2 p-2 border rounded"></textarea>
    
    <input id="product-image" type="file" accept="image/*" class="w-full mb-2" />
    
    <button onclick="saveProduct()" class="bg-blue-600 text-white px-4 py-2 rounded">บันทึกสินค้า</button>

    <hr class="my-6" />
    <h2 class="text-xl font-semibold mb-2">รายการสินค้าทั้งหมด</h2>
    <div id="product-list" class="space-y-4"></div>
  </div>

  <!-- Firebase SDKs -->
  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.4.0/firebase-app.js";
    import { getAuth, signInWithEmailAndPassword, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/10.4.0/firebase-auth.js";
    import { getDatabase, ref, push, set, get, remove, update, onValue } from "https://www.gstatic.com/firebasejs/10.4.0/firebase-database.js";
    import { getStorage, ref as storageRef, uploadBytes, getDownloadURL } from "https://www.gstatic.com/firebasejs/10.4.0/firebase-storage.js";

    const firebaseConfig = {
      apiKey: "AIzaSyCDAaW-OyL_13qkF7sCxXkMhpJyrOtntjg",
      authDomain: "orders-3d979.firebaseapp.com",
      databaseURL: "https://orders-3d979-default-rtdb.asia-southeast1.firebasedatabase.app",
      projectId: "orders-3d979",
      storageBucket: "orders-3d979.appspot.com",
      messagingSenderId: "YOUR_SENDER_ID",
      appId: "YOUR_APP_ID"
    };

    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db = getDatabase(app);
    const storage = getStorage(app);

    onAuthStateChanged(auth, user => {
      if (user) {
        document.getElementById('login-section').classList.add('hidden');
        document.getElementById('admin-panel').classList.remove('hidden');
        loadProducts();
      }
    });

    window.login = async function () {
      const email = document.getElementById('email').value;
      const password = document.getElementById('password').value;
      try {
        await signInWithEmailAndPassword(auth, email, password);
      } catch (err) {
        document.getElementById('login-error').classList.remove('hidden');
      }
    }

    window.saveProduct = async function () {
      const name = document.getElementById('product-name').value.trim();
      const category = document.getElementById('product-category').value.trim();
      const priceInput = document.getElementById('product-price').value.trim();
      const file = document.getElementById('product-image').files[0];

      if (!name || !category || !priceInput || !file) return alert("กรอกข้อมูลให้ครบ");

      const price = {};
      priceInput.split(',').forEach(item => {
        const [key, value] = item.split('=');
        price[key.trim()] = parseFloat(value.trim());
      });

      const imagePath = `product-images/${Date.now()}_${file.name}`;
      const imgRef = storageRef(storage, imagePath);
      await uploadBytes(imgRef, file);
      const imageUrl = await getDownloadURL(imgRef);

      const productRef = push(ref(db, 'products'));
      await set(productRef, {
        name, category, price, imageUrl
      });

      document.getElementById('product-name').value = '';
      document.getElementById('product-category').value = '';
      document.getElementById('product-price').value = '';
      document.getElementById('product-image').value = '';
    }

    function loadProducts() {
      const listEl = document.getElementById('product-list');
      const productsRef = ref(db, 'products');
      onValue(productsRef, snapshot => {
        listEl.innerHTML = '';
        const data = snapshot.val() || {};
        Object.entries(data).forEach(([id, product]) => {
          const div = document.createElement('div');
          div.className = "border p-4 rounded bg-white";
          div.innerHTML = `
            <p><strong>${product.name}</strong> (${product.category})</p>
            <img src="${product.imageUrl}" class="w-24 h-24 object-cover my-2 rounded border" />
            <p>ราคา: ${Object.entries(product.price).map(([k,v]) => `${k}: ${v}฿`).join(', ')}</p>
            <button onclick="deleteProduct('${id}')" class="text-red-600 mt-2 underline">ลบสินค้า</button>
          `;
          listEl.appendChild(div);
        });
      });
    }

    window.deleteProduct = async function (id) {
      if (confirm("ลบสินค้านี้หรือไม่?")) {
        await remove(ref(db, `products/${id}`));
      }
    }
  </script>

</body>
</html>
